"use strict";const{app:w,BrowserWindow:F,ipcMain:i,Tray:C,Menu:I,globalShortcut:H,screen:A,nativeImage:R,shell:W,dialog:_}=require("electron"),z=require("path"),O=require("fs"),V=require("electron-store"),{initDatabase:j,getAllNotes:L,addNote:U,updateNote:$,deleteNote:B,getNoteById:de,getAllTasks:J,addTask:q,updateTask:Q,deleteTask:G,getFolders:Z,getFiles:K,createFolder:ee,addFile:te,deleteFolder:ne,deleteFile:oe,renameFolder:ie,renameFile:se,moveFile:re}=require("./db");console.log("Database loaded. addTask type:",typeof q);const{scheduleNotification:Y,cancelNotification:he,startNotificationScheduler:ae}=require("./notifications"),g=new V;let e,S=null,X=!1;const v=80,N=400,T=600;process.platform==="darwin"&&w.dock.hide();process.platform==="win32"&&w.setAppUserModelId("com.juno.app");process.on("uncaughtException",o=>{console.error("CRITICAL ERROR:",o)});process.on("unhandledRejection",(o,t)=>{console.error("UNHANDLED REJECTION:",o)});function E(){const{width:o,height:t}=A.getPrimaryDisplay().workAreaSize,n=o-v-20,a=t-v-20;g.get("windowX",n),g.get("windowY",a),e=new F({width:v,height:v,icon:z.join(__dirname,"../ball-icon.png"),frame:!1,transparent:!0,backgroundColor:"#00000000",alwaysOnTop:!0,skipTaskbar:!0,resizable:!1,movable:!1,minimizable:!1,maximizable:!1,hasShadow:!1,webPreferences:{preload:z.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}}),process.env.NODE_ENV==="development"||!w.isPackaged?e.loadURL("http://localhost:5173").catch(s=>{console.error("Failed to load URL:",s)}):e.loadFile(z.join(__dirname,"../dist/index.html")).catch(s=>{console.error("Failed to load file:",s)}),e.show(),e.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0}),e.on("minimize",s=>{s.preventDefault()}),e.on("moved",()=>{const[s,l]=e.getPosition();g.set("windowX",s),g.set("windowY",l)}),e.setAlwaysOnTop(!0,"screen-saver"),e.webContents.on("did-finish-load",()=>{console.log("Window loaded successfully!")}),e.webContents.on("did-fail-load",(s,l,x)=>{console.error("Failed to load:",l,x)}),e.on("moved",()=>{if(X&&e){const[s,l]=e.getPosition(),[x,m]=e.getSize(),h=A.getDisplayNearestPoint({x:s,y:l}),{x:f,y:d,width:r,height:b}=h.workArea,u=f-x/2,c=d,y=f+r-x/2,p=d+b-m/2;let M=s,P=l,k=!1;s<u&&(M=u,k=!0),s>y&&(M=y,k=!0),l<c&&(P=c,k=!0),l>p&&(P=p,k=!0),k&&e.setPosition(Math.round(M),Math.round(P))}})}function le(){const o=z.join(__dirname,"../ball-icon.png"),t=R.createFromPath(o).resize({width:32,height:32});S=new C(t);const n=I.buildFromTemplate([{label:"Show/Hide",click:()=>{e&&(e.isVisible()?e.hide():(e.show(),e.focus()))}},{label:"Toggle Expand",click:()=>{e&&e.isVisible()&&e.webContents.send("toggle-from-tray")}},{type:"separator"},{label:"Quit",click:()=>{w.quit()}}]);S.setToolTip("Juno"),S.setContextMenu(n),S.on("double-click",()=>{e&&(e.isVisible()?e.hide():(e.show(),e.focus()))})}function ce(){H.register("CommandOrControl+Shift+N",()=>{e&&(e.isVisible()?e.hide():(e.show(),e.focus()))})||console.log("Registration failed")}w.whenReady().then(()=>{j(),le(),E(),ce(),ae(e),w.on("activate",()=>{F.getAllWindows().length===0&&E()})});w.on("window-all-closed",()=>{process.platform!=="darwin"&&w.quit()});w.on("will-quit",()=>{H.unregisterAll()});i.handle("get-notes",async()=>L());i.handle("add-note",async(o,t)=>{const n=U(t);return t.reminderAt&&Y(n,e),n});i.handle("update-note",async(o,t,n)=>$(t,n));i.handle("delete-note",async(o,t)=>B(t));i.handle("get-tasks",async()=>J());i.handle("add-task",async(o,t)=>{const n=q(t);return t.reminderAt&&Y({content:`Task: ${n.title}`,reminderAt:n.reminderAt,id:`task-${n.id}`},e),n});i.handle("delete-task",async(o,t)=>G(t));i.handle("update-task",async(o,t,n)=>{const a=Q(t,n);return n.reminderAt&&Y({content:`Task: ${a.title}`,reminderAt:a.reminderAt,id:`task-${a.id}`},e),a});i.handle("get-folders",async(o,t)=>Z(t));i.handle("get-files",async(o,t)=>K(t));i.handle("create-folder",async(o,t,n)=>ee(t,n));i.handle("add-file",async(o,t)=>te(t));i.handle("delete-folder",async(o,t)=>ne(t));i.handle("delete-file",async(o,t)=>oe(t));i.handle("rename-folder",async(o,t,n)=>ie(t,n));i.handle("rename-file",async(o,t,n)=>se(t,n));i.handle("move-file",async(o,t,n)=>re(t,n));i.handle("open-file",async(o,t)=>{await W.openPath(t)});i.handle("reveal-file",async(o,t)=>{W.showItemInFolder(t)});i.handle("toggle-expand",async(o,t)=>{X=t;const[n,a]=e.getPosition(),{width:s,height:l}=A.getPrimaryDisplay().workAreaSize;if(t){e.setResizable(!0),e.setMovable(!0),e.setMinimumSize(300,400),e.setMaximumSize(800,1e3),e.setSize(N,T,!0);const h=-200,f=s-N/2,d=0,r=l-T/2,b=Math.max(h,Math.min(f,n)),u=Math.max(d,Math.min(r,a));e.setPosition(Math.round(b),Math.round(u))}else e.setResizable(!1),e.setMovable(!1),e.setMinimumSize(v,v),e.setMaximumSize(v,v),e.setSize(v,v,!0),setTimeout(async()=>{if(!X&&e){const[h,f]=e.getPosition(),[d,r]=e.getSize(),b=h+d/2,u=f+r/2,c=20,y=[{x:c,y:c},{x:s-d-c,y:c},{x:c,y:l-r-c},{x:s-d-c,y:l-r-c},{x:c,y:(l-r)/2},{x:s-d-c,y:(l-r)/2},{x:(s-d)/2,y:c},{x:(s-d)/2,y:l-r-c}];let p=y[0],M=1/0;for(const P of y){const k={x:P.x+d/2,y:P.y+r/2},D=Math.sqrt(Math.pow(b-k.x,2)+Math.pow(u-k.y,2));D<M&&(M=D,p=P)}e.setPosition(Math.round(p.x),Math.round(p.y)),g.set("windowX",p.x),g.set("windowY",p.y)}},100);const[x,m]=e.getPosition();return g.set("windowX",x),g.set("windowY",m),{expanded:t}});i.handle("start-drag",async()=>!0);i.handle("get-window-position",async()=>{if(e){const[o,t]=e.getPosition();return{x:o,y:t}}return{x:0,y:0}});i.handle("get-theme",async()=>g.get("theme","dark"));i.handle("set-theme",async(o,t)=>(g.set("theme",t),t));i.on("close-app",()=>{w.quit()});i.on("hide-window",()=>{e&&e.hide()});i.on("quit-app",()=>{w.quit()});i.handle("show-context-menu",async()=>{if(!e)return;I.buildFromTemplate([{label:"Hide",click:()=>{e&&e.hide()}},{type:"separator"},{label:"Quit",click:()=>{w.quit()}}]).popup({window:e})});i.on("set-ignore-mouse-events",(o,t)=>{e&&(t?e.setIgnoreMouseEvents(!0,{forward:!0}):e.setIgnoreMouseEvents(!1))});i.handle("set-window-position",async(o,t,n)=>{if(e&&typeof t=="number"&&typeof n=="number"&&!isNaN(t)&&!isNaN(n)){const a=A.getDisplayNearestPoint({x:t,y:n}),{x:s,y:l,width:x,height:m}=a.workArea,[h,f]=e.getSize(),d=s-h/2,r=l-f/2,b=s+x-h/2,u=l+m-f/2,c=Math.round(Math.max(d,Math.min(b,t))),y=Math.round(Math.max(r,Math.min(u,n)));X?e.setPosition(c,y):e.setBounds({x:c,y,width:80,height:80})}});i.handle("finalize-drag",async()=>e&&!X?(e.setSize(80,80),e.setResizable(!1),e.setMovable(!1),!0):!1);i.handle("snap-to-edge",async()=>{if(!e||X)return;const[o,t]=e.getPosition(),[n,a]=e.getSize(),s=o+n/2,l=t+a/2,x=A.getDisplayNearestPoint({x:s,y:l}),{x:m,y:h,width:f,height:d}=x.workArea,r=20,b=[{x:m+r,y:h+r,name:"top-left"},{x:m+f-n-r,y:h+r,name:"top-right"},{x:m+r,y:h+d-a-r,name:"bottom-left"},{x:m+f-n-r,y:h+d-a-r,name:"bottom-right"},{x:m+r,y:h+(d-a)/2,name:"left-middle"},{x:m+f-n-r,y:h+(d-a)/2,name:"right-middle"},{x:m+(f-n)/2,y:h+r,name:"top-middle"},{x:m+(f-n)/2,y:h+d-a-r,name:"bottom-middle"}];let u=b[0],c=1/0;for(const y of b){const p={x:y.x+n/2,y:y.y+a/2},M=Math.sqrt(Math.pow(s-p.x,2)+Math.pow(l-p.y,2));M<c&&(c=M,u=y)}return e.setPosition(Math.round(u.x),Math.round(u.y)),g.set("windowX",u.x),g.set("windowY",u.y),{x:u.x,y:u.y,edge:u.name}});i.handle("select-file",async()=>{if(!e)return[];try{const{canceled:o,filePaths:t}=await _.showOpenDialog(e,{properties:["openFile","multiSelections"]});return o?[]:t.map(n=>{try{const a=O.statSync(n);return{name:z.basename(n),originalPath:n,size:a.size,fileType:"file"}}catch(a){return console.error("Error reading file stats:",a),null}}).filter(n=>n!==null)}catch(o){return console.error("Error selecting file:",o),[]}});i.on("ondragstart",async(o,t)=>{if(e)try{const n=await w.getFileIcon(t);o.sender.startDrag({file:t,icon:n})}catch(n){console.error("Drag error:",n)}});i.on("set-window-position",(o,{x:t,y:n})=>{e&&e.setPosition(Math.round(t),Math.round(n))});
